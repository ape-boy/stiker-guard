rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // 헬퍼 함수: 사용자 인증 확인
    function isAuthenticated() {
      return request.auth != null;
    }

    // 헬퍼 함수: 본인 데이터 접근 확인
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // 헬퍼 함수: 계정 잠금 여부 확인
    function isAccountLocked(userId) {
      return get(/databases/$(database)/documents/users/$(userId)).data.accountStatus == 'locked';
    }

    // users 컬렉션 규칙
    match /users/{userId} {
      // 읽기: 본인만 가능
      allow read: if isOwner(userId);

      // 생성: 인증된 사용자만, 자신의 문서만
      allow create: if isOwner(userId) &&
                       request.resource.data.keys().hasAll(['createdAt', 'accountStatus']) &&
                       request.resource.data.accountStatus == 'active';

      // 업데이트: 본인만, 계정 잠금 상태가 아닐 때
      allow update: if isOwner(userId) && !isAccountLocked(userId);

      // 삭제: 불가 (Cloud Functions에서만 처리)
      allow delete: if false;

      // checkIns 서브컬렉션
      match /checkIns/{checkInId} {
        // 읽기: 본인만
        allow read: if isOwner(userId);

        // 생성: 본인만, 계정 잠금 상태가 아닐 때
        allow create: if isOwner(userId) &&
                         !isAccountLocked(userId) &&
                         request.resource.data.keys().hasAll(['date', 'checkedAt', 'hasSticker']);

        // 업데이트, 삭제: 불가 (변경 불가능한 기록)
        allow update, delete: if false;
      }

      // stats 서브컬렉션
      match /stats/{statsId} {
        // 읽기: 본인만
        allow read: if isOwner(userId);

        // 생성, 업데이트: 본인만 또는 서버
        allow create, update: if isOwner(userId);

        // 삭제: 불가
        allow delete: if false;
      }
    }

    // 기본적으로 모든 접근 거부
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
