name: iOS Build & Deploy (Release)

# âš ï¸ ì´ ì›Œí¬í”Œë¡œìš°ëŠ” Apple Developer ê³„ì •ì´ í•„ìš”í•©ë‹ˆë‹¤
# í™œì„±í™”í•˜ë ¤ë©´: workflow_dispatchì˜ ì£¼ì„ì„ ì œê±°í•˜ì„¸ìš”

on:
  # push:
  #   tags:
  #     - 'v*'
  # workflow_dispatch:
  workflow_dispatch:  # ìˆ˜ë™ ì‹¤í–‰ë§Œ í—ˆìš© (í…ŒìŠ¤íŠ¸ìš©)

env:
  XCODE_VERSION: '15.0'
  IOS_VERSION: '13.4'

jobs:
  build-release:
    name: Build & Deploy iOS App
    runs-on: macos-13

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install npm dependencies
      run: npm ci

    - name: ğŸ Install CocoaPods dependencies
      run: |
        cd ios
        pod install --repo-update
        cd ..

    # ====== ì½”ë“œ ì‚¬ì´ë‹ ì„¤ì • ======
    - name: ğŸ” Import Code Signing Certificates
      env:
        BUILD_CERTIFICATE_BASE64: ${{ secrets.BUILD_CERTIFICATE_BASE64 }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # ì¸ì¦ì„œë¥¼ ì„ì‹œ íŒŒì¼ë¡œ ë””ì½”ë”©
        CERTIFICATE_PATH=$RUNNER_TEMP/build_certificate.p12
        echo -n "$BUILD_CERTIFICATE_BASE64" | base64 --decode -o $CERTIFICATE_PATH

        # ì„ì‹œ í‚¤ì²´ì¸ ìƒì„±
        KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
        security create-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH
        security set-keychain-settings -lut 21600 $KEYCHAIN_PATH
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" $KEYCHAIN_PATH

        # ì¸ì¦ì„œë¥¼ í‚¤ì²´ì¸ì— import
        security import $CERTIFICATE_PATH -P "$P12_PASSWORD" -A -t cert -f pkcs12 -k $KEYCHAIN_PATH
        security list-keychain -d user -s $KEYCHAIN_PATH

    - name: ğŸ“ Import Provisioning Profile
      env:
        BUILD_PROVISION_PROFILE_BASE64: ${{ secrets.BUILD_PROVISION_PROFILE_BASE64 }}
      run: |
        # Provisioning Profile ë””ì½”ë”© ë° ì„¤ì¹˜
        PP_PATH=$RUNNER_TEMP/build_pp.mobileprovision
        echo -n "$BUILD_PROVISION_PROFILE_BASE64" | base64 --decode -o $PP_PATH

        # Provisioning Profile ì„¤ì¹˜ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles

        # UUID ì¶”ì¶œ ë° ë³µì‚¬
        PP_UUID=$(grep -aA1 UUID $PP_PATH | grep string | sed -e 's/<string>//' -e 's/<\/string>//' | tr -d '\t')
        cp $PP_PATH ~/Library/MobileDevice/Provisioning\ Profiles/$PP_UUID.mobileprovision

    # ====== ë¹Œë“œ ======
    - name: ğŸ”¨ Build iOS App (Archive)
      run: |
        xcodebuild archive \
          -workspace ios/StickerGuard.xcworkspace \
          -scheme StickerGuard \
          -configuration Release \
          -archivePath $PWD/build/StickerGuard.xcarchive \
          -destination 'generic/platform=iOS' \
          CODE_SIGN_STYLE=Manual \
          DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }} \
          CODE_SIGN_IDENTITY="iPhone Distribution" \
          PROVISIONING_PROFILE_SPECIFIER="${{ secrets.PROVISIONING_PROFILE_NAME }}" \
          clean archive

    - name: ğŸ“¦ Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath $PWD/build/StickerGuard.xcarchive \
          -exportPath $PWD/build \
          -exportOptionsPlist ios/ExportOptions.plist

    # ====== TestFlight ì—…ë¡œë“œ ======
    - name: ğŸš€ Upload to TestFlight
      env:
        APP_STORE_CONNECT_API_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
        APP_STORE_CONNECT_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_BASE64: ${{ secrets.APP_STORE_CONNECT_API_KEY_BASE64 }}
      run: |
        # App Store Connect API Key ì„¤ì •
        mkdir -p ~/private_keys
        echo -n "$APP_STORE_CONNECT_API_KEY_BASE64" | base64 --decode -o ~/private_keys/AuthKey_$APP_STORE_CONNECT_API_KEY_ID.p8

        # TestFlightì— ì—…ë¡œë“œ
        xcrun altool --upload-app \
          --type ios \
          --file build/StickerGuard.ipa \
          --apiKey $APP_STORE_CONNECT_API_KEY_ID \
          --apiIssuer $APP_STORE_CONNECT_ISSUER_ID

    # ====== ì •ë¦¬ ======
    - name: ğŸ§¹ Clean up keychain and provisioning profile
      if: always()
      run: |
        security delete-keychain $RUNNER_TEMP/app-signing.keychain-db || true
        rm ~/Library/MobileDevice/Provisioning\ Profiles/* || true

    # ====== Artifacts ì—…ë¡œë“œ ======
    - name: ğŸ“¤ Upload IPA
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: StickerGuard-Release-IPA
        path: build/StickerGuard.ipa
        retention-days: 30

    - name: ğŸ“¤ Upload dSYM (for crash reporting)
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: StickerGuard-dSYM
        path: build/StickerGuard.xcarchive/dSYMs/
        retention-days: 90

    - name: ğŸ“Š Build Summary
      if: success()
      run: |
        echo "âœ… iOS Release Build & Upload Successful!"
        echo "ğŸ“± Configuration: Release"
        echo "ğŸš€ Uploaded to: TestFlight"
        echo "ğŸ“¦ IPA: build/StickerGuard.ipa"
