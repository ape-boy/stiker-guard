name: iOS Build (Simulator)

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:

jobs:
  build-simulator:
    name: Build for iOS Simulator
    runs-on: macos-latest

    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4

    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'

    - name: ğŸ“¦ Install npm dependencies
      run: npm ci

    - name: ğŸ Install CocoaPods dependencies
      run: |
        cd ios
        pod install --repo-update
        cd ..

    - name: ğŸ”¨ Build for iOS Simulator
      run: |
        xcodebuild \
          -workspace ios/StickerGuard.xcworkspace \
          -scheme StickerGuard \
          -configuration Debug \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          -derivedDataPath ios/build \
          build

    - name: âœ… Run Unit Tests
      run: |
        xcodebuild test \
          -workspace ios/StickerGuard.xcworkspace \
          -scheme StickerGuard \
          -configuration Debug \
          -sdk iphonesimulator \
          -destination 'platform=iOS Simulator,name=iPhone 15,OS=latest' \
          -derivedDataPath ios/build \
          || echo "âš ï¸ Tests not configured yet"

    - name: ğŸ“Š Build Summary
      if: success()
      run: |
        echo "âœ… iOS Simulator Build Successful!"
        echo "ğŸ“± Target: iPhone 15 Simulator"
        echo "ğŸ”§ Configuration: Debug"
        echo "ğŸ“¦ Output: ios/build/Build/Products/Debug-iphonesimulator/StickerGuard.app"

    - name: ğŸ“¤ Upload .app artifact
      uses: actions/upload-artifact@v4
      if: success()
      with:
        name: StickerGuard-Simulator
        path: ios/build/Build/Products/Debug-iphonesimulator/StickerGuard.app
        retention-days: 7

    - name: ğŸ” Upload build logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: build-logs
        path: |
          ~/Library/Logs/DiagnosticReports/
          ios/build/Logs/
        retention-days: 3
